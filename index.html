<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Movement Report Filter</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: auto; }
    label, input, button { display: block; margin-bottom: 1rem; }
    button { padding: 0.5rem 1rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #666; padding: 4px; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>Movement Report Generator</h1>

  <label>
    1. Choose your BF Excel file:
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
  </label>

  <label>
    2. Enter Release ref:
    <input type="text" id="refInput" placeholder="e.g. ABC123" />
  </label>

  <button id="generate">Generate Report</button>

  <!-- 5) Report output area -->
  <h2>Report Output</h2>
  <div id="reportContainer"></div>

  <script>
    function headerIndex(headers, name) {
      return headers.findIndex(h => h === name);
    }

    document.getElementById('generate').addEventListener('click', () => {
      const fileElem = document.getElementById('fileInput');
      const ref = document.getElementById('refInput').value.trim();
      if (!fileElem.files.length) return alert('Please choose your Excel file first.');
      if (!ref) return alert('Please enter a Release ref number.');

      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(e.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        if (rows.length < 2) return alert('No data found.');

        const headers = rows[0];
        const wantCols = [
          "Release ref","Container Nbr","Type",
          "On hire Location","On hire date","Return Location"
        ];
        const idxMap = wantCols.map(col => {
          const i = headerIndex(headers, col);
          if (i < 0) throw `Column "${col}" not found.`;
          return i;
        });

        // Build output array
        const out = [ wantCols ];
        const refCol = headerIndex(headers, "Release ref");
        for (let i=1; i<rows.length; i++) {
          if (String(rows[i][refCol]) === ref) {
            out.push(idxMap.map(ci => rows[i][ci]||""));
          }
        }
        if (out.length === 1) return alert(`No rows for "${ref}".`);

        // Render HTML table
        const reportDiv = document.getElementById('reportContainer');
        reportDiv.innerHTML = '';
        const table = document.createElement('table');
        const headerRow = document.createElement('tr');
        out[0].forEach(col => {
          const th = document.createElement('th');
          th.innerText = col;
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);
        out.slice(1).forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.innerText = cell;
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
        reportDiv.appendChild(table);

        // Copy button
        const copyBtn = document.createElement('button');
        copyBtn.innerText = 'Copy Report to Clipboard';
        copyBtn.style.marginTop = '0.5rem';
        copyBtn.onclick = () => {
          const tsv = out.map(r => r.join('\t')).join('\n');
          navigator.clipboard.writeText(tsv)
            .then(()=> alert('Report copied!'))
            .catch(()=> alert('Copy failed'));
        };
        reportDiv.appendChild(copyBtn);
      };
      reader.onerror = () => alert('Failed to read file!');
      reader.readAsBinaryString(fileElem.files[0]);
    });
  </script>
</body>
</html>
